console.log("Hello!"),hideCross("mdiv1"),hideCross("mdiv2");const debugging=!0;var strokeWidth=10,scrollbarWidth=20,width=window.innerWidth-scrollbarWidth,height=window.innerHeight-50,osziFlash=new Array,csvGroupCache=new Array,ursprungXoffset=.14*width,ursprungYoffset=.12*height,xDiffPerCent=.0614,yDiffPerCent=.0776,yDiffWeiteCH1=20,yDiffWeiteCH2=20,xDiffWeite=1,lineStepOnLogLine=[0,.301,.176,.125,.097,.079,.067,.058,.051,.046],firstDekadeEndeLOG=1,ursprungXoffsetLOG=.04*width,xDiffDekPerCentLOG=.3409,ursprungYoffsetLOG=.9238*height,yDiffPerCentLOG=.0859,yDiffWeiteLOG=5,platzHalterKali=[ursprungXoffset,ursprungYoffset,xDiffPerCent,yDiffPerCent,xDiffWeite,yDiffWeiteCH1,yDiffWeiteCH2],backroundKalibrierungTab=[[0,0,0,0,0,0],[.1423*width,.1191*height,.0614,.0776,20,1,1],[.1223*width,.0684*height,.0651,.0531,.1,.1,.1],[.1073*width,.1836*height,.1014,.1018,1,.1,.1],[.1351*width,.1816*height,.0657,.1021,1,.1,.1],[.3273*width,.5019*height,.0635,.1192,1,1,1],platzHalterKali,platzHalterKali,platzHalterKali,[.3262*width,.5019*height,.3156,.1192,.24,111.6,111.6],[.0714*width,.0684*height,.0361,.0532,5,1,1],[.0601*width,.0645*height,.0295,.0477,100,20,20],[ursprungXoffsetLOG,ursprungYoffsetLOG,xDiffDekPerCentLOG,yDiffPerCentLOG,xDiffWeite,5,firstDekadeEndeLOG],[ursprungXoffsetLOG,ursprungYoffsetLOG,xDiffDekPerCentLOG,yDiffPerCentLOG,xDiffWeite,10,firstDekadeEndeLOG],[ursprungXoffset,ursprungYoffset,xDiffPerCent,yDiffPerCent,xDiffWeite,yDiffWeiteCH1,yDiffWeiteCH2]],backroundKalibrierung=backroundKalibrierungTab[1],canvas=document.createElement("canvas");canvas.width=width,canvas.height=height;var stage=new Konva.Stage({container:"container",width:width,height:height}),image=new Konva.Image({image:canvas,x:0,y:0,stroke:"red",strokeWidth:strokeWidth}),text=new Konva.Text({x:10,y:10,fontFamily:"Calibri",fontSize:24,text:"",fill:"black"}),circle=new Konva.Circle({x:stage.width()/2,y:stage.height()/2,radius:1,fill:"transparent",stroke:"red",strokeWidth:2}),context=canvas.getContext("2d");context.strokeStyle="#000000",context.lineJoin="round",context.lineWidth=1;var lastPointerPosition,isPaint=!1,mode="brush",countGerade=0,countText=0,countImage=0,shadowOffset=20,tween=null,blockSnapSize=20,layer=new Konva.Layer,backlayer=new Konva.Layer,circlelayer=new Konva.Layer,textlayer=new Konva.Layer,gridGroup=new Konva.Group;circlelayer.add(circle),layer.add(image),textlayer.add(text),backlayer.add(gridGroup),stage.add(backlayer),stage.add(circlelayer),stage.add(layer),stage.add(textlayer);var padding=blockSnapSize;console.log("_______________Info Gridding_______________"),console.log("Breite: "+width),console.log("Kästchen: "+padding),console.log("Anzahl Kästchen: "+width/padding),console.log("_______________Info Kalibrierung_______________"),console.log("** Klichen Sie den Ursprung und das Offset wird Ihnen Angezeigt **"),console.log("Breite = "+width),console.log("Höhe = "+height),stage.on("click",(e=>{let t=getPointerOnElement(stage),o=t.x,s=t.y;console.log("New Click New Offset"),console.log("x-Offset = "+o/width),console.log("y-Offset = "+(height-s)/height)}));for(var i=0;i<width/padding;i++){let e=new Konva.Line({points:[Math.round(i*padding)+.5,0,Math.round(i*padding)+.5,height],stroke:"#ddd",strokeWidth:1});gridGroup.add(e)}for(var j=0;j<height/padding;j++){let e=new Konva.Line({points:[0,Math.round(j*padding),width,Math.round(j*padding)],stroke:"#ddd",strokeWidth:.5});gridGroup.add(e)}var arrowCount=0;function newArrow(e){let t="Vektor "+ ++arrowCount,o=new Konva.Group({id:t});var s=new Konva.Arrow({id:t,points:[blockSnapSize,blockSnapSize,5*blockSnapSize,blockSnapSize],draggable:!0,fill:"black",stroke:"black",strokeWidth:4,shadowOffset:{x:1,y:1},hitStrokeWidth:20,shadowOpacity:.4,pointerLength:blockSnapSize,pointerWidth:.5*blockSnapSize});let a=new Konva.Circle({x:5*blockSnapSize,y:blockSnapSize,radius:13,fill:"grey",stroke:"black",draggable:!0,opacity:.25});var i=new Konva.Label({x:170,y:75,opacity:.75,draggable:!0});i.add(new Konva.Tag({fill:"black",pointerDirection:"down",pointerWidth:10,pointerHeight:10,lineJoin:"round",shadowColor:"black",shadowBlur:10,shadowOffsetX:10,shadowOffsetY:10,shadowOpacity:.5}));let r=new Konva.Text({text:" ",fontFamily:"Calibri",fontSize:18,padding:5,fill:"white"});setVektorName(r,s,blockSnapSize),i.add(r),o.add(s),o.add(i),o.add(a),a.on("dragmove",(e=>{let t=s.getPoints(),o=s.getPosition(),i=a.getPosition();t[2]=i.x-o.x,t[3]=i.y-o.y,s.setPoints(t),setVektorName(r,s,blockSnapSize),stage.batchDraw()})),s.on("dragmove",(e=>{let t=s.getPoints(),o=s.getPosition();a.position({x:t[2]+o.x,y:t[3]+o.y}),stage.batchDraw()})),s.on("dblclick dbltap",(function(){this.getParent().destroy(),stage.draw()})),i.on("dblclick dbltap",(()=>{var e=r.getAbsolutePosition(),t=stage.container().getBoundingClientRect(),o=t.left+e.x,a=t.top+e.y,i=document.createElement("textarea");document.body.appendChild(i),i.value=s.id(),i.style.position="absolute",i.style.top=a+"px",i.style.left=o+"px",i.style.width=r.width()+"px",i.focus(),i.addEventListener("keydown",(function(e){13===e.keyCode&&(s.id(i.value),setVektorName(r,s,blockSnapSize),stage.draw(),document.body.removeChild(i))}))})),textlayer.add(o),stage.draw(),showAsGrabbable(s),showAsGrabbable(r),showAsGrabbable(a),makeItHover(a,stage),makeItHover(s,stage)}let osziControls=new Array;function newPanel(e,t,o,s,a,i,r){let n=new Array;n=s?[["0.01ms",1e-5],["0.02ms",2e-5],["0.05ms",5e-5],["0.1ms",1e-4],["0.2ms",2e-4],["0.5ms",5e-4],["1ms",.001]]:[["0.01V",.01],["0.02V",.02],["0.05V",.05],["0.1V",.1],["0.2V",.2],["0.5V",.5],["1V",1]];let d=roundDown(n.length/2);function l(e,t){let o="lightgray",s="gray",a="gray",i="white";e.on("mouseover touchstart",(function(){e.setAttrs({fill:o}),t.setAttrs({fill:s})})),e.on("mouseout touchend",(function(){e.setAttrs({fill:a}),t.setAttrs({fill:i})})),e.on("mousedown",(function(){t.setAttrs({fill:"red"})})),e.on("mouseup",(function(){t.setAttrs({fill:i})})),t.on("mouseover touchstart",(function(){t.setAttrs({fill:s}),e.setAttrs({fill:o})})),t.on("mouseout touchend",(function(){t.setAttrs({fill:i}),e.setAttrs({fill:a})})),t.on("mousedown",(function(){t.setAttrs({fill:"red"})})),t.on("mouseup",(function(){t.setAttrs({fill:i})}))}s?backroundKalibrierungTab[5][4]=n[d][1]:backroundKalibrierungTab[5][5]=n[d][1];var c=new Konva.Label({id:e+d,x:i,y:r,opacity:.75,draggable:!0});c.add(new Konva.Rect({fill:"lightgray",width:120,height:80,stroke:"red",strokeWidth:1})),c.add(new Konva.Text({width:120,height:80,text:t,fontFamily:"Calibri",fontSize:22,align:"center",fontStyle:"bold",padding:5,fill:"black"}));var u=new Konva.Rect({id:"up"+e,x:5,y:28,width:20,height:20,fill:"gray",shadowBlur:3,cornerRadius:2}),m=new Konva.Rect({id:"down"+e,x:5,y:53,width:20,height:20,fill:"gray",shadowBlur:3,cornerRadius:2}),g=new Konva.Text({id:"upArrow"+e,x:28,y:28,text:"<",fontFamily:"Calibri",fontSize:25,padding:2,rotation:90,fontStyle:"bold",fill:"white"}),h=new Konva.Text({id:"downArrow"+e,x:2,y:73,text:"<",fontFamily:"Calibri",fontSize:25,padding:2,rotation:270,fontStyle:"bold",fill:"white"}),f=new Konva.Text({y:9,width:120,height:80,text:n[d][0],fontFamily:"Calibri",fontSize:20,align:"right",verticalAlign:"middle",fontStyle:"bold",padding:10,fill:"black"});return c.add(f),c.add(u),c.add(g),c.add(m),c.add(h),l(u,g),l(m,h),u.on("click touchstart",(function(){d<n.length&&d++,f.text(n[d][0]),s?backroundKalibrierungTab[5][4]=n[d][1]:backroundKalibrierungTab[5][4+a]=n[d][1],stage.batchDraw()})),g.on("click touchstart",(function(){d<n.length-1&&d++,f.text(n[d][0]),s?backroundKalibrierungTab[5][4]=n[d][1]:backroundKalibrierungTab[5][4+a]=n[d][1],stage.batchDraw()})),m.on("click touchstart",(function(){d>0&&d--,f.text(n[d][0]),s?backroundKalibrierungTab[5][4]=n[d][1]:backroundKalibrierungTab[5][4+a]=n[d][1],stage.batchDraw()})),h.on("click touchstart",(function(){d>0&&d--,f.text(n[d][0]),s?backroundKalibrierungTab[5][4]=n[d][1]:backroundKalibrierungTab[5][4+a]=n[d][1],stage.batchDraw()})),showAsClickable(u),showAsClickable(g),showAsClickable(m),showAsClickable(h),o.add(c),c}osziControls.push(newPanel("Zeit","CH1/CH2",textlayer,!0,0,.7822*width,.27*height)),osziControls.push(newPanel("VoltCH1","CH1",textlayer,!1,1,.7282*width,.704*height)),osziControls.push(newPanel("VoltCH2","CH2",textlayer,!1,2,.7282*width+130,.704*height)),osziControls.forEach((e=>{e.hide(),textlayer.draw()}));var imageObj=new Image;function changeToolBackground(){let e=document.getElementById("hintergrund").value;imageObj.src=sources[e],backroundKalibrierung=backroundKalibrierungTab[e],console.log(e),5==e?osziControls.forEach((e=>{e.show(),textlayer.draw()})):osziControls.forEach((e=>{e.hide(),textlayer.draw()}))}function writeMessage(e){text.text(e)}imageObj.onload=function(){let e=document.getElementById("hintergrund").value;var t=new Konva.Image({draggable:!1,x:.8*strokeWidth,y:.8*strokeWidth,image:imageObj,width:width-2*strokeWidth*.8,height:height-2*strokeWidth*.8});backlayer.add(t),7==e?gridGroup.show():gridGroup.hide(),stage.draw()},imageObj.src="Data/invisible.svg",stage.draw(),stage.on("mousedown touchstart",(function(){layer.setZIndex(2),circlelayer.setZIndex(1),stage.draw(),isPaint=!0,lastPointerPosition=stage.getPointerPosition()})),stage.on("mouseup touchend",(function(){layer.setZIndex(1),circlelayer.setZIndex(2),stage.draw(),isPaint=!1})),stage.on("mousemove touchmove",(function(){var e=getPointerOnElement(stage),t=e.x,o=e.y;circle.x(t),circle.y(o),circle.radius(.5*pixcount.value),stage.batchDraw()})),image.on("mousemove touchmove",(function(){var e=getPointerOnElement(stage);if(writeMessage("x: "+e.x+", y: "+e.y),isPaint){"brush"===mode&&(context.globalCompositeOperation="source-over"),"eraser"===mode&&(context.globalCompositeOperation="destination-out"),context.beginPath();var t={x:lastPointerPosition.x-image.x(),y:lastPointerPosition.y-image.y()};context.moveTo(t.x,t.y);var o=stage.getPointerPosition();t={x:o.x-image.x(),y:o.y-image.y()},context.lineTo(t.x,t.y),context.closePath(),context.stroke(),lastPointerPosition=o,layer.batchDraw()}}));var Mousemode=document.getElementById("container");Mousemode.classList.add("pencil");var select=document.getElementById("Zeichentool");select.addEventListener("change",(function(){"brush"===(mode=select.value)&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser"))}));var pixcount=document.getElementById("pix");function updateColor(){let e=document.getElementById("pencilColor");context.strokeStyle=e.value}function preview_image(e){countImage+=1;var t=new Image(width-2*strokeWidth*.8,height-2*strokeWidth*.8),o=new FileReader;o.onload=function(){t.src=o.result};var s=document.getElementById("pic").files[0];console.log(s),o.readAsDataURL(e.target.files[0]);var a=new Konva.Image({image:t,draggable:!1,x:.8*strokeWidth,y:.8*strokeWidth});const i=new Konva.Circle({x:7+20*countImage,y:20,radius:10,fill:"red"});textlayer.add(i);const r=new Konva.Text({text:"x",x:2+20*countImage,y:10,fontSize:charpix});textlayer.add(r),i.on("touchstart click",(()=>{i.destroy(),r.destroy(),a.destroy(),stage.draw()})),r.on("touchstart click",(()=>{i.destroy(),r.destroy(),a.destroy(),stage.draw()})),i.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),this.setAttrs({fill:"#AA0000"}),textlayer.draw(),is_touch_device()&&this.setAttrs({fill:"red"})})),i.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),this.setAttrs({fill:"red"}),textlayer.draw()})),r.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),i.setAttrs({fill:"#AA0000"}),textlayer.draw(),is_touch_device()&&i.setAttrs({fill:"red"})})),r.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),i.setAttrs({fill:"red"}),textlayer.draw()})),setTimeout((function(){backlayer.add(a),backlayer.batchDraw(),stage.draw()}),100)}pixcount.addEventListener("change",(function(){context.lineWidth=pixcount.value,circle.radius(.5*pixcount.value),stage.draw()}));var charpix=20;function createTextfeld(){countText+=1;var e=new Konva.Text({text:"Doppelclick zum Editieren.",x:50+10*countText,y:80+10*countText,fontSize:charpix,draggable:!0,width:200});textlayer.add(e);var t=new Konva.Transformer({node:e,enabledAnchors:["middle-right"],boundBoxFunc:function(e,t){return t.width=Math.max(30,t.width),t}});const o=new Konva.Circle({x:t.getWidth()-20,y:-15,radius:10,fill:"red"});t.add(o);const s=new Konva.Text({text:"x",x:t.getWidth()-25,y:-25,fontSize:charpix});t.add(s);const a=new Konva.Circle({x:t.getWidth()-0,y:-15,radius:10,fill:"grey"});t.add(a),t.on("transform",(()=>{drawing=!1,o.x(t.getWidth()-20),s.x(t.getWidth()-25),a.x(t.getWidth()-0)})),o.on("touchstart click",(()=>{t.destroy(),e.destroy(),textlayer.draw()})),s.on("touchstart click",(()=>{t.destroy(),e.destroy(),textlayer.draw()})),a.on("touchstart click",(()=>{t.hide(),textlayer.draw()})),e.on("transform",(function(){drawing=!1,e.setAttrs({width:e.width()*e.scaleX(),scaleX:1})})),textlayer.add(t),textlayer.draw(),1==is_touch_device()?e.on("touchstart",(()=>{if(t.show(),textlayer.draw(),1==doubletap()){t.hide(),e.hide(),textlayer.draw();var o=e.absolutePosition(),s=stage.container().getBoundingClientRect(),a={x:s.left+o.x,y:s.top+o.y},i=document.createElement("textarea");document.body.appendChild(i),i.value=e.text(),i.style.position="absolute",i.style.top=a.y+"px",i.style.left=a.x+"px",i.style.width=e.width()-2*e.padding()+"px",i.style.height=e.height()-2*e.padding()+5+"px",i.style.fontSize=e.fontSize()+"px",i.style.border="none",i.style.padding="0px",i.style.margin="0px",i.style.overflow="hidden",i.style.background="none",i.style.outline="none",i.style.resize="none",i.style.lineHeight=e.lineHeight(),i.style.fontFamily=e.fontFamily(),i.style.transformOrigin="left top",i.style.textAlign=e.align(),i.style.color=e.fill(),rotation=e.rotation();var r="";rotation&&(r+="rotateZ("+rotation+"deg)");var n=0;function d(){i.parentNode.removeChild(i),window.removeEventListener("click",l),e.show(),t.show(),t.forceUpdate(),textlayer.draw()}function l(o){o.target!==i&&(e.text(i.value),d(),t.hide(),textlayer.draw())}navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(n+=2+Math.round(e.fontSize()/20)),r+="translateY(-"+n+"px)",i.style.transform=r,i.style.height="auto",i.style.height=i.scrollHeight+3+"px",i.focus(),i.addEventListener("keydown",(function(o){13!==o.keyCode||o.shiftKey||(e.text(i.value),d(),t.hide(),textlayer.draw()),27===o.keyCode&&d()})),i.addEventListener("keydown",(function(t){scale=e.getAbsoluteScale().x,function(t){t||(t=e.placeholder.length*e.fontSize());var o=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),s=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;(o||s)&&(t=Math.ceil(t)),(document.documentMode||/Edge/.test(navigator.userAgent))&&(t+=1),i.style.width=t+"px"}(e.width()*scale),i.style.height="auto",i.style.height=i.scrollHeight+e.fontSize()+"px"})),setTimeout((()=>{window.addEventListener("tochstart",l)}))}})):(e.on("mousedown",(()=>{t.show(),textlayer.draw()})),e.on("dblclick",(()=>{t.hide(),e.hide(),textlayer.draw();var o=e.absolutePosition(),s=stage.container().getBoundingClientRect(),a=s.left+o.x,i=s.top+o.y,r=document.createElement("textarea");document.body.appendChild(r),r.value=e.text(),r.style.position="absolute",r.style.top=i+"px",r.style.left=a+"px",r.style.width=e.width()-2*e.padding()+"px",r.style.height=e.height()-2*e.padding()+5+"px",r.style.fontSize=e.fontSize()+"px",r.style.border="none",r.style.padding="0px",r.style.margin="0px",r.style.overflow="hidden",r.style.background="none",r.style.outline="none",r.style.resize="none",r.style.lineHeight=e.lineHeight(),r.style.fontFamily=e.fontFamily(),r.style.transformOrigin="left top",r.style.textAlign=e.align(),r.style.color=e.fill(),rotation=e.rotation();var n="";rotation&&(n+="rotateZ("+rotation+"deg)");var d=0;function l(){r.parentNode.removeChild(r),window.removeEventListener("click",c),e.show(),t.show(),t.forceUpdate(),textlayer.draw()}function c(o){o.target!==r&&(e.text(r.value),l(),t.hide(),textlayer.draw())}navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(d+=2+Math.round(e.fontSize()/20)),n+="translateY(-"+d+"px)",r.style.transform=n,r.style.height="auto",r.style.height=r.scrollHeight+3+"px",r.focus(),r.addEventListener("keydown",(function(o){13!==o.keyCode||o.shiftKey||(e.text(r.value),l(),t.hide(),textlayer.draw()),27===o.keyCode&&l()})),r.addEventListener("keydown",(function(t){scale=e.getAbsoluteScale().x,function(t){t||(t=e.placeholder.length*e.fontSize());var o=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),s=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;(o||s)&&(t=Math.ceil(t)),(document.documentMode||/Edge/.test(navigator.userAgent))&&(t+=1),r.style.width=t+"px"}(e.width()*scale),r.style.height="auto",r.style.height=r.scrollHeight+e.fontSize()+"px"})),setTimeout((()=>{window.addEventListener("click",c)}))}))),a.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),this.setAttrs({fill:"#CCCCCC"}),textlayer.draw(),is_touch_device()&&this.setAttrs({fill:"grey"})})),a.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),this.setAttrs({fill:"grey"}),textlayer.draw()})),o.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),this.setAttrs({fill:"#AA0000"}),textlayer.draw(),is_touch_device()&&this.setAttrs({fill:"red"})})),o.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),this.setAttrs({fill:"red"}),textlayer.draw()})),s.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),o.setAttrs({fill:"#AA0000"}),textlayer.draw(),is_touch_device()&&o.setAttrs({fill:"red"})})),s.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),o.setAttrs({fill:"red"}),textlayer.draw()})),e.on("mouseover",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.add("grabbable")})),e.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser"))}))}function downloadURI(e,t){var o=document.createElement("a");o.download=t,o.href=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),delete o}function handleInputKeydown(e){13===e.which&&downloadPic()}function downloadPic(){let e=stage.toDataURL().replace("image/png","image/octet-stream");console.log(e);document.createElement("a");let t=document.getElementById("exportInput");""==t.value?downloadURI(e,"ZT.png"):t.value.search(".png")>-1?downloadURI(e,t.value):downloadURI(e,t.value+".png")}function readpoints(e,t,o,s){let a=document.getElementById("hintergrund").value,i=!1;12!=a&&13!=a||(i=!0);let r=document.getElementById(s),n=s.replace("Graph",""),d=getRandomColor();var l=new Konva.Label({x:75,y:50+25*n,draggable:!0});l.add(new Konva.Tag({fill:"#bbb",stroke:d,shadowColor:"black",shadowBlur:3,shadowOffset:[10,10],shadowOpacity:.7,lineJoin:"round",pointerDirection:"right",pointerWidth:10,pointerHeight:10,cornerRadius:5})),l.add(new Konva.Text({text:r.value,fontSize:12,lineHeight:1.2,padding:2,fill:d})),showAsGrabbable(l);var c=new Konva.Group({});textlayer.add(c),c.add(l);for(var u=get(e),m=0;m<u.length;m++)if(m%2==1)u[m]=-1*(u[m]/backroundKalibrierung[5]*(backroundKalibrierung[3]*height)-height+backroundKalibrierung[1]);else if(i){let e=u[m];e*=1.001;let t=0,o=0;for(;e>1;)e/=10,t++;let s=0,a=10*e-roundDown(10*e);for(s=1;s<=10*e;s++)o+=lineStepOnLogLine[s-1];lineStepOnLogLine[0|e];u[m]=t*backroundKalibrierung[2]*width+o*backroundKalibrierung[2]*width+backroundKalibrierung[0]+a*lineStepOnLogLine[s-1]*backroundKalibrierung[2]*width,console.log("Rest: "+a),console.log("K: "+s),console.log("lineStepOnLogLine[k-1]: "+lineStepOnLogLine[s-1]),console.log("xxOff: "+10*-(0|e)+10*e),console.log("extraOff: "+o),console.log("Ausgabe: "+u[m])}else u[m]=u[m]/backroundKalibrierung[4]*(backroundKalibrierung[2]*width)+backroundKalibrierung[0];for(var g=0;g<u.length;g+=2){var h=new Konva.Circle({x:u[g],y:u[g+1],radius:5,fill:d,stroke:"black",strokeWidth:4});c.add(h)}console.log("_______________Info Gelesene Punkte_______________"),console.log(u);var f=new Konva.Line({points:u,tension:.5,strokeWidth:3,hitStrokeWidth:20,stroke:d});c.add(f),document.getElementById(t).addEventListener("click",(function(){c.destroy(),stage.draw()}),!1),document.getElementById(o).addEventListener("click",(function(){c.destroy(),stage.draw()}),!1),stage.draw()}function showcsv(e,t){let o=drawGraph(e,t);csvGroupCache[t]=o;let s=new Array,a=stage.findOne("#upZeit"),i=stage.findOne("#downZeit"),r=stage.findOne("#upArrowZeit"),n=stage.findOne("#downArrowZeit");if(1==t){let e=stage.findOne("#upVoltCH1"),t=stage.findOne("#downVoltCH1"),o=stage.findOne("#upArrowVoltCH1"),d=stage.findOne("#downArrowVoltCH1");s=[a,i,r,n,e,t,o,d]}else{let e=stage.findOne("#upVoltCH2"),t=stage.findOne("#downVoltCH2"),o=stage.findOne("#upArrowVoltCH2"),d=stage.findOne("#downArrowVoltCH2");s=[a,i,r,n,e,t,o,d]}s.forEach(((e,t)=>{e.addEventListener("click.event1",(function(){s.forEach((e=>{e.off("click.event1")})),void 0!==csvGroupCache[1]&&(csvGroupCache[1].destroy(),showcsv(osziFlash[1],1)),void 0!==csvGroupCache[2]&&(csvGroupCache[2].destroy(),showcsv(osziFlash[2],2)),stage.draw()}),!1)}))}function drawGraph(e,t){t=void 0!==t?t:1;document.getElementById("hintergrund").value;let o=document.getElementById("quali"+t),s=(document.getElementById("f"),parseFloat(o.value)),a="CSVData "+t;e.shift();let i="#000000";void 0!==csvGroupCache[t]&&csvGroupCache[t].destroy(),i=1==t?"#0000FF":"#00FF00";var r=new Konva.Label({x:75,y:200,draggable:!0});r.add(new Konva.Tag({fill:"#bbb",stroke:i,shadowColor:"black",shadowBlur:3,shadowOffset:[10,10],shadowOpacity:.7,lineJoin:"round",pointerDirection:"right",pointerWidth:10,pointerHeight:10,cornerRadius:5})),r.add(new Konva.Text({text:a,fontSize:12,lineHeight:1.2,padding:2,fill:i})),showAsGrabbable(r);var n=new Konva.Group({});textlayer.add(n),n.add(r);let d=new Array;for(var l=0;l<e.length;l+=s)d.push(parseFloat(e[l][0])),d.push(parseFloat(e[l][1]));for(l=0;l<d.length;l++)d[l]=l%2==1?-1*(d[l]/backroundKalibrierung[4+t]*(backroundKalibrierung[3]*height)-height+backroundKalibrierung[1]):d[l]/backroundKalibrierung[4]*(backroundKalibrierung[2]*width)+backroundKalibrierung[0];for(var c=0;c<d.length;c+=2){var u=new Konva.Circle({x:d[c],y:d[c+1],radius:5,fill:i,stroke:"black",strokeWidth:4});n.add(u)}var m=new Konva.Line({points:d,tension:.5,strokeWidth:3,hitStrokeWidth:20,stroke:i});return n.add(m),stage.draw(),n}function createLine(){countGerade+=1;var e=new Konva.Circle({x:stage.width()/2+10*countGerade,y:stage.height()/2+10*countGerade,radius:10,fill:"grey",stroke:"black",strokeWidth:1,draggable:!0}),t=e.absolutePosition(),o=new Konva.Circle({x:stage.width()/2+100+10*countGerade,y:stage.height()/2+10*countGerade,radius:10,fill:"grey",stroke:"black",strokeWidth:1,draggable:!0}),s=o.absolutePosition(),a=new Konva.Line({points:[t.x,t.y,s.x,s.y],stroke:getRandomColor(),strokeWidth:3,lineCap:"round",lineJoin:"round",tension:1,draggable:!1}),i=new Konva.Transformer({node:a,enabledAnchors:[],rotateEnabled:!1});const r=new Konva.Circle({x:i.getWidth()-20,y:-20,radius:10,fill:"red"});i.add(r);const n=new Konva.Text({text:"x",x:i.getWidth()-25,y:-30,fontSize:charpix});i.add(n);const d=new Konva.Circle({x:i.getWidth()-40,y:-20,radius:10,fillRadialGradientStartPoint:{x:0,y:0},fillRadialGradientStartRadius:0,fillRadialGradientEndPoint:{x:0,y:0},fillRadialGradientEndRadius:8,fillRadialGradientColorStops:[0,"red",.5,"yellow",1,"blue"]});i.add(d);const l=new Konva.Circle({x:i.getWidth()-0,y:-20,radius:10,fill:"grey"});i.add(l),textlayer.add(i),textlayer.add(e),textlayer.add(o),textlayer.add(a),a.moveToBottom(),textlayer.draw(),e.on("dragmove",(function(){i.show(),drawing=!1,t=e.absolutePosition(),a.setAttrs({points:[t.x,t.y,s.x,s.y]}),r.x(i.getWidth()-20),n.x(i.getWidth()-25),l.x(i.getWidth()-0),d.x(i.getWidth()-40),textlayer.batchDraw()})),o.on("dragmove",(function(){i.show(),drawing=!1,s=o.absolutePosition(),a.setAttrs({points:[t.x,t.y,s.x,s.y]}),r.x(i.getWidth()-20),n.x(i.getWidth()-25),l.x(i.getWidth()-0),d.x(i.getWidth()-40),textlayer.batchDraw()})),r.on("touchstart click",(()=>{i.destroy(),a.destroy(),e.destroy(),o.destroy(),stage.draw()})),n.on("touchstart click",(()=>{i.destroy(),a.destroy(),e.destroy(),o.destroy(),stage.draw()})),d.on("click touchstart",(()=>{a.setAttrs({stroke:getRandomColor()}),stage.draw()})),l.on("click touchstart",(()=>{i.hide(),stage.draw()})),o.on("mouseover",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.add("grabbable")})),e.on("mouseover",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.add("grabbable")})),o.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser"))})),e.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser"))})),d.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),this.setAttrs({fillRadialGradientStartPoint:{x:0,y:0},fillRadialGradientStartRadius:0,fillRadialGradientEndPoint:{x:0,y:0},fillRadialGradientEndRadius:8,fillRadialGradientColorStops:[0,"blue",.5,"yellow",1,"red"]}),textlayer.draw()})),d.on("mouseout touchend",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),this.setAttrs({fillRadialGradientStartPoint:{x:0,y:0},fillRadialGradientStartRadius:0,fillRadialGradientEndPoint:{x:0,y:0},fillRadialGradientEndRadius:8,fillRadialGradientColorStops:[0,"red",.5,"yellow",1,"blue"]}),textlayer.draw()})),l.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),this.setAttrs({fill:"#CCCCCC"}),textlayer.draw(),is_touch_device()&&this.setAttrs({fill:"grey"})})),l.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),this.setAttrs({fill:"grey"}),textlayer.draw()})),r.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),this.setAttrs({fill:"#AA0000"}),textlayer.draw(),is_touch_device()&&this.setAttrs({fill:"red"})})),r.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),this.setAttrs({fill:"red"}),textlayer.draw()})),n.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),r.setAttrs({fill:"#AA0000"}),textlayer.draw(),is_touch_device()&&r.setAttrs({fill:"red"})})),n.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),r.setAttrs({fill:"red"}),textlayer.draw()}))}function hilfe(){$((function(){$("#dialog").dialog({height:.8*height,width:.8*width})}))}function clearContext(){context.clearRect(0,0,canvas.width,canvas.height),stage.draw()}document.getElementById("exportInput").addEventListener("keypress",handleInputKeydown,!1);