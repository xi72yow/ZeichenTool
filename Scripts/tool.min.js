debugging&&console.log("Hello! ZT in Debugging. (deactivate in zeichentool.html script tag id: debugging state)");var basicToolStrokeWidth=2,strokeWidth=10,scrollbarWidth=20,width=window.innerWidth-scrollbarWidth,height=window.innerHeight-50,scalex=1,scaley=1,osziFlash=new Array,csvGroupCache=new Array,ursprungXoffset=.14*width,ursprungYoffset=.12*height,xDiffPerCent=.0614,yDiffPerCent=.0776,yDiffWeiteCH1=20,yDiffWeiteCH2=20,xDiffWeite=1,lineStepOnLogLine=[0,.301,.176,.125,.097,.079,.067,.058,.051,.046],firstDekadeEndeLOG=1,ursprungXoffsetLOG=.04*width,xDiffDekPerCentLOG=.3409,ursprungYoffsetLOG=.9238*height,yDiffPerCentLOG=.0859,yDiffWeiteLOG=5,platzHalterKali=[ursprungXoffset,ursprungYoffset,xDiffPerCent,yDiffPerCent,xDiffWeite,yDiffWeiteCH1,yDiffWeiteCH2],backroundKalibrierungTab=[[.1373*width,.1432*height,.0577,.1019,5,1],[.1235*width,.0917*height,.0642,.0833,20,1,1],[.1223*width,.0684*height,.0651,.0531,.1,.1,.1],[.1073*width,.1836*height,.1014,.1018,1,.1,.1],[.1351*width,.1816*height,.0657,.1021,1,.1,.1],[.3273*width,.5019*height,.0635,.1192,1,1,1],platzHalterKali,platzHalterKali,platzHalterKali,[.3262*width,.5019*height,.3156,.1192,.24,111.6,111.6],[.0714*width,.0684*height,.0361,.0532,5,1,1],[.0601*width,.0645*height,.0295,.0477,100,20,20],[ursprungXoffsetLOG,ursprungYoffsetLOG,xDiffDekPerCentLOG,yDiffPerCentLOG,xDiffWeite,5,firstDekadeEndeLOG],[ursprungXoffsetLOG,ursprungYoffsetLOG,xDiffDekPerCentLOG,yDiffPerCentLOG,xDiffWeite,10,firstDekadeEndeLOG],[ursprungXoffset,ursprungYoffset,xDiffPerCent,yDiffPerCent,xDiffWeite,yDiffWeiteCH1,yDiffWeiteCH2]],backroundKalibrierung=backroundKalibrierungTab[1];let container=document.getElementById("container");var canvas=document.createElement("canvas");canvas.width=width,canvas.height=height;var stage=new Konva.Stage({container:"container",width:width,height:height}),image=new Konva.Image({image:canvas,x:0,y:0,stroke:"red",strokeWidth:strokeWidth}),text=new Konva.Text({x:10,y:10,fontFamily:"Calibri",fontSize:24,text:"",fill:"black"}),circle=new Konva.Circle({x:stage.width()/2,y:stage.height()/2,radius:1,fill:"transparent",stroke:"red",strokeWidth:2}),context=canvas.getContext("2d");context.strokeStyle="#000000",context.lineJoin="round",context.lineWidth=1;var isPaint=!1,lastPointerPosition={x:0,y:0},mode="brush",countGerade=0,countText=0,countImage=0,shadowOffset=20,tween=null,blockSnapSize=20,layer=new Konva.Layer,backlayer=new Konva.Layer,circlelayer=new Konva.Layer,textlayer=new Konva.Layer,gridGroup=new Konva.Group;circlelayer.add(circle),layer.add(image),circlelayer.add(text),backlayer.add(gridGroup),stage.add(backlayer),stage.add(circlelayer),stage.add(layer),stage.add(textlayer);var padding=blockSnapSize;debugging&&(console.log("_______________Info Gridding_______________"),console.log("Breite: "+width),console.log("Kästchen: "+padding),console.log("Anzahl Kästchen: "+width/padding),console.log("_______________Info Kalibrierung_______________"),console.log("** Klichen Sie den Ursprung und das Offset wird Ihnen Angezeigt **"),console.log("Breite = "+width),console.log("Höhe = "+height),stage.on("click",(e=>{let t=stage.getPointerPosition(),o=t.x,a=t.y;console.log("New Click New Offset"),console.log("x-Offset = "+o/width),console.log("y-Offset = "+(height-a)/height)})));for(var i=0;i<width/padding;i++){let e=new Konva.Line({points:[Math.round(i*padding)+.5,0,Math.round(i*padding)+.5,height],stroke:"#ddd",strokeWidth:1});gridGroup.add(e)}for(var j=0;j<height/padding;j++){let e=new Konva.Line({points:[0,Math.round(j*padding),width,Math.round(j*padding)],stroke:"#ddd",strokeWidth:.5});gridGroup.add(e)}var arrowCount=0;function newArrow(e,t={x:0,y:0},o=[blockSnapSize,blockSnapSize,5*blockSnapSize,blockSnapSize],a={x:5*blockSnapSize,y:blockSnapSize},s={x:170,y:75},i=`Vektor ${arrowCount}`){arrowCount++;let n=i,r=new Konva.Group({id:n,name:"arrow-save"});var l=new Konva.Arrow({id:n,...t,points:o,draggable:!0,fill:"black",stroke:"black",strokeWidth:4,shadowOffset:{x:1,y:1},hitStrokeWidth:20,shadowOpacity:.4,pointerLength:blockSnapSize,pointerWidth:.5*blockSnapSize});let d=new Konva.Circle({...a,radius:13,fill:"grey",stroke:"black",draggable:!0,opacity:.25});var c=new Konva.Label({...s,opacity:.75,draggable:!0});c.add(new Konva.Tag({fill:"black",pointerDirection:"down",pointerWidth:10,pointerHeight:10,lineJoin:"round",shadowColor:"black",shadowBlur:10,shadowOffsetX:10,shadowOffsetY:10,shadowOpacity:.5}));let u=new Konva.Text({text:" ",fontFamily:"Calibri",fontSize:18,padding:5,fill:"white"});function g(e){let t=l.getPoints(),o=l.getPosition(),a=d.getPosition();t[2]=a.x-o.x,t[3]=a.y-o.y,l.setPoints(t)}setVektorName(u,l,blockSnapSize),c.add(u),r.add(l),r.add(c),r.add(d),g(),d.on("dragmove",(e=>{g(),setVektorName(u,l,blockSnapSize),stage.batchDraw()})),l.on("dragmove",(e=>{let t=l.getPoints(),o=l.getPosition();d.position({x:t[2]+o.x,y:t[3]+o.y}),stage.batchDraw()})),l.on("dblclick dbltap",(function(){this.getParent().destroy(),stage.draw()})),c.on("dblclick dbltap",(()=>{var e=u.getAbsolutePosition(),t=stage.container().getBoundingClientRect(),o=t.left+e.x,a=t.top+e.y,s=document.createElement("textarea");document.body.appendChild(s),s.value=l.id(),s.style.position="absolute",s.style.top=a+"px",s.style.left=o+"px",s.style.width=u.width()+"px",s.focus(),s.addEventListener("keydown",(function(e){13===e.keyCode&&(l.id(s.value),setVektorName(u,l,blockSnapSize),stage.draw(),document.body.removeChild(s))}))})),textlayer.add(r),stage.draw(),showAsGrabbable(l),showAsGrabbable(u),showAsGrabbable(d),makeItHover(d,stage),makeItHover(l,stage)}let osziControls=new Array;function newPanel(e,t,o,a,s,i,n){let r=new Array,l=[["0.01ms",1e-5],["0.02ms",2e-5],["0.05ms",5e-5],["0.1ms",1e-4],["0.2ms",2e-4],["0.5ms",5e-4],["1ms",.001]];r=a?l:[["0.01V",.01],["0.02V",.02],["0.05V",.05],["0.1V",.1],["0.2V",.2],["0.5V",.5],["1V",1],["2V",2],["5V",5]];let d=roundDown(r.length/2);function c(e,t){let o="lightgray",a="gray",s="gray",i="white";e.on("mouseover touchstart",(function(){e.setAttrs({fill:o}),t.setAttrs({fill:a})})),e.on("mouseout touchend",(function(){e.setAttrs({fill:s}),t.setAttrs({fill:i})})),e.on("mousedown",(function(){t.setAttrs({fill:"red"})})),e.on("mouseup",(function(){t.setAttrs({fill:i})})),t.on("mouseover touchstart",(function(){t.setAttrs({fill:a}),e.setAttrs({fill:o})})),t.on("mouseout touchend",(function(){t.setAttrs({fill:i}),e.setAttrs({fill:s})})),t.on("mousedown",(function(){t.setAttrs({fill:"red"})})),t.on("mouseup",(function(){t.setAttrs({fill:i})}))}a?backroundKalibrierungTab[5][4]=r[d][1]:backroundKalibrierungTab[5][5]=r[d][1];var u=new Konva.Label({id:e+d,x:i,y:n,opacity:.75,draggable:!0});u.add(new Konva.Rect({fill:"lightgray",width:120,height:80,stroke:"red",strokeWidth:1})),u.add(new Konva.Text({width:120,height:80,text:t,fontFamily:"Calibri",fontSize:22,align:"center",fontStyle:"bold",padding:5,fill:"black"}));var g=new Konva.Rect({id:"up"+e,x:5,y:28,width:20,height:20,fill:"gray",shadowBlur:3,cornerRadius:2}),h=new Konva.Rect({id:"down"+e,x:5,y:53,width:20,height:20,fill:"gray",shadowBlur:3,cornerRadius:2}),m=new Konva.Text({id:"upArrow"+e,x:28,y:28,text:"<",fontFamily:"Calibri",fontSize:25,padding:2,rotation:90,fontStyle:"bold",fill:"white"}),f=new Konva.Text({id:"downArrow"+e,x:2,y:73,text:"<",fontFamily:"Calibri",fontSize:25,padding:2,rotation:270,fontStyle:"bold",fill:"white"}),v=new Konva.Text({y:9,width:120,height:80,text:r[d][0],fontFamily:"Calibri",fontSize:20,align:"right",verticalAlign:"middle",fontStyle:"bold",padding:10,fill:"black"});return u.add(v),u.add(g),u.add(m),u.add(h),u.add(f),c(g,m),c(h,f),g.on("click touchstart",(function(){d<l.length-1&&d++,v.text(r[d][0]),a?backroundKalibrierungTab[5][4]=r[d][1]:backroundKalibrierungTab[5][4+s]=r[d][1],stage.batchDraw()})),m.on("click touchstart",(function(){d<r.length-1&&d++,v.text(r[d][0]),a?backroundKalibrierungTab[5][4]=r[d][1]:backroundKalibrierungTab[5][4+s]=r[d][1],stage.batchDraw()})),h.on("click touchstart",(function(){d>0&&d--,v.text(r[d][0]),a?backroundKalibrierungTab[5][4]=r[d][1]:backroundKalibrierungTab[5][4+s]=r[d][1],stage.batchDraw()})),f.on("click touchstart",(function(){d>0&&d--,v.text(r[d][0]),a?backroundKalibrierungTab[5][4]=r[d][1]:backroundKalibrierungTab[5][4+s]=r[d][1],stage.batchDraw()})),showAsClickable(g),showAsClickable(m),showAsClickable(h),showAsClickable(f),textlayer.add(u),u}osziControls.push(newPanel("Zeit","CH1/CH2",textlayer,!0,0,.7822*width,.27*height)),osziControls.push(newPanel("VoltCH1","CH1",textlayer,!1,1,.7282*width,.704*height)),osziControls.push(newPanel("VoltCH2","CH2",textlayer,!1,2,.7282*width+130,.704*height)),osziControls.forEach((e=>{e.hide(),textlayer.draw()}));var imageObj=new Image;function setBackground(e){document.getElementById("hintergrund").selectedIndex=e,changeToolBackground()}function changeToolBackground(){let e=document.getElementById("hintergrund").value;imageObj.src=sources[e],backroundKalibrierung=backroundKalibrierungTab[e],document.getElementById("wertetabellenInfo").innerHTML=einheitenInfo[e],debugging&&console.log("Background: "+e),5==e?osziControls.forEach((e=>{e.show(),textlayer.draw()})):osziControls.forEach((e=>{e.hide(),textlayer.draw()}))}let timeoutRef,currentShape;function handleLongPress(e){console.log("long press"),console.log(e.target),openContextMenue(e)}function handleTouchStart(e){e.target.parentElement!=menuNode&&(menuNode.style.display="none"),timeoutRef=setTimeout((()=>{handleLongPress(e)}),600)}function handleTouchEnd(){clearTimeout(timeoutRef)}imageObj.onload=function(){let e=document.getElementById("hintergrund").value;var t=new Konva.Image({draggable:!1,x:.8*strokeWidth,y:.8*strokeWidth,image:imageObj,width:width-2*strokeWidth*.8,height:height-2*strokeWidth*.8});backlayer.add(t),7==e?gridGroup.show():gridGroup.hide(),stage.draw()},imageObj.src="Data/invisible.svg",stage.draw(),stage.on("touchstart mousedown",handleTouchStart),stage.on("touchend mouseup",handleTouchEnd),stage.on("touchmove mousemove",handleTouchEnd);var menuNode=document.getElementById("menu");function openContextMenue(e){if(drawing=!1,e.evt.preventDefault(),e.target===textlayer||e.target===layer||e.target===image||e.target===container)return void clearTimeout(timeoutRef);currentShape=e.target,menuNode.style.display="initial";const t=stage.container().getBoundingClientRect();menuNode.style.top=`${t.top+stage.getPointerPosition().y+4}px`,menuNode.style.left=`${t.left+stage.getPointerPosition().x+4}px`}function writeMessage(e){text.text(e)}function updateColor(){let e=document.getElementById("BasicToolColorInput");context.strokeStyle=e.value}function preview_image(e){countImage+=1;var t=new Image(width-2*strokeWidth*.8,height-2*strokeWidth*.8),o=new FileReader;o.onload=function(){t.src=o.result};var a=document.getElementById("file-input-pic").files[0];console.log(a),o.readAsDataURL(e.target.files[0]);var s=new Konva.Image({image:t,draggable:!1,x:.8*strokeWidth,y:.8*strokeWidth});const i=new Konva.Circle({x:7+20*countImage,y:20,radius:10,fill:"red"});textlayer.add(i);const n=new Konva.Text({text:"x",x:2+20*countImage,y:10,fontSize:charpix});textlayer.add(n),i.on("touchstart click",(()=>{i.destroy(),n.destroy(),s.destroy(),stage.draw()})),n.on("touchstart click",(()=>{i.destroy(),n.destroy(),s.destroy(),stage.draw()})),i.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),this.setAttrs({fill:"#AA0000"}),textlayer.draw(),is_touch_device()&&this.setAttrs({fill:"red"})})),i.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),this.setAttrs({fill:"red"}),textlayer.draw()})),n.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),i.setAttrs({fill:"#AA0000"}),textlayer.draw(),is_touch_device()&&i.setAttrs({fill:"red"})})),n.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),i.setAttrs({fill:"red"}),textlayer.draw()})),setTimeout((function(){backlayer.add(s),backlayer.batchDraw(),stage.draw()}),100)}document.getElementById("pulse-button").addEventListener("click",(()=>{console.log(currentShape),currentShape.to({scaleX:2,scaleY:2,onFinish:()=>{currentShape.to({scaleX:1,scaleY:1})}})})),document.getElementById("delete-button").addEventListener("click",(()=>{"line-save"!==currentShape.getParent().getAttr("name")&&"text-save"!==currentShape.getParent().getAttr("name")&&"arrow-save"!==currentShape.getParent().getAttr("name")||(currentShape.getParent().destroy(),stage.batchDraw(),menuNode.style.display="none"),"arrow-save"===currentShape.getParent().getParent().getAttr("name")&&(currentShape.getParent().getParent().destroy(),stage.batchDraw(),menuNode.style.display="none")})),menuNode.addEventListener("focusout",(()=>{menuNode.style.display="none"})),stage.on("contextmenu",(function(e){openContextMenue(e)})),stage.on("mousedown touchstart",(function(){layer.setZIndex(2),circlelayer.setZIndex(1),stage.draw(),isPaint=!0,lastPointerPosition=stage.getPointerPosition()})),stage.on("mouseup touchend",(function(){layer.setZIndex(1),circlelayer.setZIndex(2),stage.draw(),isPaint=!1})),stage.on("mousemove touchmove",(function(e){var t=stage.getPointerPosition(),o=t.x*(1/scalex),a=t.y*(1/scaley);circle.x(o),circle.y(a),stage.batchDraw()})),stage.on("mouseleave",(function(e){isPaint=!1})),image.on("mousemove touchmove",(function(e){var t=stage.getPointerPosition(),o=t.x,a=t.y;if(debugging&&writeMessage("x: "+o+", y: "+a),isPaint){"brush"===mode&&(context.globalCompositeOperation="source-over"),"eraser"===mode&&(context.globalCompositeOperation="destination-out"),context.beginPath(),context.moveTo(lastPointerPosition.x*(1/scalex),lastPointerPosition.y*(1/scaley));var s=stage.getPointerPosition();context.lineTo(s.x*(1/scalex),s.y*(1/scaley)),context.closePath(),context.stroke(),lastPointerPosition=s,layer.batchDraw()}}));var charpix=20;function createTextfeld(e,t,o=0,a=1,s=1,i="Doppelclick zum Editieren."){t=void 0!==t?t:{x:50+10*countText,y:80+10*countText},countText+=1;var n=new Konva.Group({name:"text-save"}),r=new Konva.Text({text:i,x:t.x,y:t.y,fontSize:charpix,draggable:!0,rotation:o,width:200,scaleX:s,scaleY:a}),l=new Konva.Transformer({node:r,enabledAnchors:["middle-right"],boundBoxFunc:function(e,t){return t.width=Math.max(30,t.width),t}});let d;r.scaleX(s),r.scaleY(a),l.scaleX(s),l.scaleY(a),l.on("transform",(()=>{drawing=!1})),r.on("transform",(function(){drawing=!1,r.setAttrs({width:r.width()*r.scaleX()})})),n.add(r),n.add(l),textlayer.add(n),textlayer.draw(),l.hide(),n.on("touchstart mousedown",(()=>{l.show(),clearTimeout(d),d=setTimeout((()=>{l.hide(),textlayer.draw()}),3e3),textlayer.draw()})),1==is_touch_device()?r.on("touchstart",(()=>{if(textlayer.draw(),1==doubletap()){l.hide(),r.hide(),textlayer.draw();var e=r.absolutePosition(),t=stage.container().getBoundingClientRect(),o={x:t.left+e.x,y:t.top+e.y},a=document.createElement("textarea");document.body.appendChild(a),a.value=r.text(),a.style.position="absolute",a.style.top=o.y+"px",a.style.left=o.x+"px",a.style.width=r.width()-2*r.padding()+"px",a.style.height=r.height()-2*r.padding()+5+"px",a.style.fontSize=r.fontSize()+"px",a.style.border="none",a.style.padding="0px",a.style.margin="0px",a.style.overflow="hidden",a.style.background="none",a.style.outline="none",a.style.resize="none",a.style.lineHeight=r.lineHeight(),a.style.fontFamily=r.fontFamily(),a.style.transformOrigin="left top",a.style.textAlign=r.align(),a.style.color=r.fill(),rotation=r.rotation();var s="";rotation&&(s+="rotateZ("+rotation+"deg)");var i=0;function n(){a.parentNode.removeChild(a),window.removeEventListener("click",d),r.show(),l.show(),l.forceUpdate(),textlayer.draw()}function d(e){e.target!==a&&(r.text(a.value),n(),l.hide(),textlayer.draw())}navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(i+=2+Math.round(r.fontSize()/20)),s+="translateY(-"+i+"px)",a.style.transform=s,a.style.height="auto",a.style.height=a.scrollHeight+3+"px",a.focus(),a.addEventListener("keydown",(function(e){13!==e.keyCode||e.shiftKey||(r.text(a.value),n(),l.hide(),textlayer.draw()),27===e.keyCode&&n()})),a.addEventListener("keydown",(function(e){scale=r.getAbsoluteScale().x,function(e){e||(e=r.placeholder.length*r.fontSize());var t=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),o=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;(t||o)&&(e=Math.ceil(e)),(document.documentMode||/Edge/.test(navigator.userAgent))&&(e+=1),a.style.width=e+"px"}(r.width()*scale),a.style.height="auto",a.style.height=a.scrollHeight+r.fontSize()+"px"})),setTimeout((()=>{window.addEventListener("tochstart",d)}))}})):(r.on("mousedown",(()=>{l.show(),textlayer.draw()})),r.on("dblclick",(()=>{l.hide(),r.hide(),textlayer.draw();var e=r.absolutePosition(),t=stage.container().getBoundingClientRect(),o=t.left+e.x,a=t.top+e.y,s=document.createElement("textarea");document.body.appendChild(s),s.value=r.text(),s.style.position="absolute",s.style.top=a+"px",s.style.left=o+"px",s.style.width=r.width()-2*r.padding()+"px",s.style.height=r.height()-2*r.padding()+5+"px",s.style.fontSize=r.fontSize()+"px",s.style.border="none",s.style.padding="0px",s.style.margin="0px",s.style.overflow="hidden",s.style.background="none",s.style.outline="none",s.style.resize="none",s.style.lineHeight=r.lineHeight(),s.style.fontFamily=r.fontFamily(),s.style.transformOrigin="left top",s.style.textAlign=r.align(),s.style.color=r.fill(),rotation=r.rotation();var i="";rotation&&(i+="rotateZ("+rotation+"deg)");var n=0;function d(){s.parentNode.removeChild(s),window.removeEventListener("click",c),r.show(),l.show(),l.forceUpdate(),textlayer.draw()}function c(e){e.target!==s&&(r.text(s.value),d(),l.hide(),textlayer.draw())}navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&(n+=2+Math.round(r.fontSize()/20)),i+="translateY(-"+n+"px)",s.style.transform=i,s.style.height="auto",s.style.height=s.scrollHeight+3+"px",s.focus(),s.addEventListener("keydown",(function(e){13!==e.keyCode||e.shiftKey||(r.text(s.value),d(),l.hide(),textlayer.draw()),27===e.keyCode&&d()})),s.addEventListener("keydown",(function(e){scale=r.getAbsoluteScale().x,function(e){e||(e=r.placeholder.length*r.fontSize());var t=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),o=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;(t||o)&&(e=Math.ceil(e)),(document.documentMode||/Edge/.test(navigator.userAgent))&&(e+=1),s.style.width=e+"px"}(r.width()*scale),s.style.height="auto",s.style.height=s.scrollHeight+r.fontSize()+"px"})),setTimeout((()=>{window.addEventListener("click",c)}))}))),r.on("mouseover",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.add("grabbable")})),r.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser"))}))}function downloadURI(e,t){var o=document.createElement("a");o.download=t,o.href=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),delete o}function handleInputKeydown(e){13===e.which&&downloadPic()}function downloadPic(){let e=stage.toDataURL().replace("image/png","image/octet-stream"),t=document.getElementById("exportInput");""==t.value?downloadURI(e,"ZT.png"):t.value.search(".png")>-1?downloadURI(e,t.value):downloadURI(e,t.value+".png")}function readpoints(e,t){let o,a,s,i;void 0!==t?(o="dataTable"+t,a="dGraph"+t,s="showGraph"+t,i="graph-name"+t):(o="dataTable0",a="dGraph0",s="showGraph0",i="graph-name0");let n=document.getElementById("hintergrund").value,r=!1;12!=n&&13!=n||(r=!0);let l=document.getElementById(i),d=getRandomColor();var c=new Konva.Label({x:75,y:75,draggable:!0});c.add(new Konva.Tag({fill:"#bbb",stroke:d,shadowColor:"black",shadowBlur:3,shadowOffset:[10,10],shadowOpacity:.7,lineJoin:"round",pointerDirection:"right",pointerWidth:10,pointerHeight:10,cornerRadius:5})),c.add(new Konva.Text({text:l.value,fontSize:12,lineHeight:1.2,padding:2,fill:d})),showAsGrabbable(c);var u=new Konva.Group({});textlayer.add(u),u.add(c);for(var g=get(o),h=0;h<g.length;h++)if(h%2==1)g[h]=-1*(g[h]/backroundKalibrierung[5]*(backroundKalibrierung[3]*height)-height+backroundKalibrierung[1]);else if(r){let e=g[h];e*=1.001;let t=0,o=0;for(;e>1;)e/=10,t++;let a=0,s=10*e-roundDown(10*e);for(a=1;a<=10*e;a++)o+=lineStepOnLogLine[a-1];lineStepOnLogLine[0|e];g[h]=t*backroundKalibrierung[2]*width+o*backroundKalibrierung[2]*width+backroundKalibrierung[0]+s*lineStepOnLogLine[a-1]*backroundKalibrierung[2]*width,debugging&&(console.log("Rest: "+s),console.log("K: "+a),console.log("lineStepOnLogLine[k-1]: "+lineStepOnLogLine[a-1]),console.log("xxOff: "+10*-(0|e)+10*e),console.log("extraOff: "+o),console.log("Ausgabe: "+g[h]))}else g[h]=g[h]/backroundKalibrierung[4]*(backroundKalibrierung[2]*width)+backroundKalibrierung[0];for(var m=0;m<g.length;m+=2){var f=new Konva.Circle({x:g[m],y:g[m+1],radius:5,fill:d,stroke:"black",strokeWidth:4}),v=new Konva.Text({x:g[m]+5,y:g[m+1]+5,text:"P"+m/2,fontSize:20,fontFamily:"Calibri",fill:d});u.add(f),u.add(v)}debugging&&(console.log("_______________Info Gelesene Punkte_______________"),console.log(g));var b=new Konva.Line({points:g,tension:.5,strokeWidth:3,hitStrokeWidth:20,stroke:d});u.add(b),document.getElementById(a).addEventListener("click",(function(){u.destroy(),stage.draw()}),!1),document.getElementById(s).addEventListener("click",(function(){u.destroy(),stage.draw()}),!1),stage.draw()}function showcsv(e,t){let o=drawGraph(e,t);console.log("group",o),csvGroupCache[t]=o;let a=new Array,s=stage.findOne("#upZeit"),i=stage.findOne("#downZeit"),n=stage.findOne("#upArrowZeit"),r=stage.findOne("#downArrowZeit");if(1==t){let e=stage.findOne("#upVoltCH1"),t=stage.findOne("#downVoltCH1"),o=stage.findOne("#upArrowVoltCH1"),l=stage.findOne("#downArrowVoltCH1");a=[s,i,n,r,e,t,o,l]}else{let e=stage.findOne("#upVoltCH2"),t=stage.findOne("#downVoltCH2"),o=stage.findOne("#upArrowVoltCH2"),l=stage.findOne("#downArrowVoltCH2");a=[s,i,n,r,e,t,o,l]}a.forEach(((e,t)=>{e.addEventListener("click.event1",(function(){a.forEach((e=>{e.off("click.event1")})),void 0!==csvGroupCache[1]&&(csvGroupCache[1].destroy(),showcsv(osziFlash[1],1)),void 0!==csvGroupCache[2]&&(csvGroupCache[2].destroy(),showcsv(osziFlash[2],2)),stage.draw()}),!1)})),stage.draw()}function drawGraph(e,t){t=void 0!==t?t:1;document.getElementById("hintergrund").value;let o=document.getElementById("quali-"+t),a=(document.getElementById("f"),parseFloat(o.value)),s="CSVData "+t;e.shift();let i="#000000";void 0!==csvGroupCache[t]&&csvGroupCache[t].destroy(),i=1==t?"#0000FF":"#00FF00";var n=new Konva.Label({x:75,y:200,draggable:!0});n.add(new Konva.Tag({fill:"#bbb",stroke:i,shadowColor:"black",shadowBlur:3,shadowOffset:[10,10],shadowOpacity:.7,lineJoin:"round",pointerDirection:"right",pointerWidth:10,pointerHeight:10,cornerRadius:5})),n.add(new Konva.Text({text:s,fontSize:12,lineHeight:1.2,padding:2,fill:i})),n.on("dblclick",(function(){csvGroupCache[t].destroy()})),showAsGrabbable(n);var r=new Konva.Group({});textlayer.add(r),r.add(n);let l=new Array;for(var d=0;d<e.length;d+=a)l.push(parseFloat(e[d][0])),l.push(parseFloat(e[d][1]));for(d=0;d<l.length;d++)l[d]=d%2==1?-1*(l[d]/backroundKalibrierung[4+t]*(backroundKalibrierung[3]*height)-height+backroundKalibrierung[1]):l[d]/backroundKalibrierung[4]*(backroundKalibrierung[2]*width)+backroundKalibrierung[0];for(var c=0;c<l.length;c+=2){var u=new Konva.Circle({x:l[c],y:l[c+1],radius:5,fill:i,stroke:"black",strokeWidth:4});r.add(u)}var g=new Konva.Line({points:l,tension:.5,strokeWidth:3,hitStrokeWidth:20,stroke:i});return r.add(g),r}function createLine(e,t,o){t=void 0!==t?t:{x:stage.width()/2+10*countGerade,y:stage.height()/2+10*countGerade},o=void 0!==o?o:{x:stage.width()/2+100+10*countGerade,y:stage.height()/2+10*countGerade};var a=new Konva.Group({name:"line-save"});countGerade+=1;var s=new Konva.Circle({x:t.x,y:t.y,radius:10,fill:"grey",stroke:"black",strokeWidth:1,draggable:!0}),i=s.absolutePosition(),n=new Konva.Circle({x:o.x,y:o.y,radius:10,fill:"grey",stroke:"black",strokeWidth:1,draggable:!0}),r=n.absolutePosition(),l=new Konva.Line({points:[i.x,i.y,r.x,r.y],stroke:getRandomColor(),strokeWidth:3,lineCap:"round",lineJoin:"round",tension:1,draggable:!1}),d=new Konva.Transformer({node:l,enabledAnchors:[],rotateEnabled:!1});const c=new Konva.Circle({x:d.getWidth()-20,y:-20,radius:10,fill:"red"});d.add(c);const u=new Konva.Text({text:"x",x:d.getWidth()-25,y:-30,fontSize:charpix});d.add(u);const g=new Konva.Circle({x:d.getWidth()-40,y:-20,radius:10,fillRadialGradientStartPoint:{x:0,y:0},fillRadialGradientStartRadius:0,fillRadialGradientEndPoint:{x:0,y:0},fillRadialGradientEndRadius:8,fillRadialGradientColorStops:[0,"red",.5,"yellow",1,"blue"]});d.add(g);const h=new Konva.Circle({x:d.getWidth()-0,y:-20,radius:10,fill:"grey"});d.add(h),a.add(s,n,l,d),textlayer.add(a),l.moveToBottom(),textlayer.draw(),s.on("dragmove",(function(){d.show(),drawing=!1,i=s.getPosition(),l.setAttrs({points:[i.x,i.y,r.x,r.y]}),c.x(d.getWidth()-20),u.x(d.getWidth()-25),h.x(d.getWidth()-0),g.x(d.getWidth()-40),textlayer.batchDraw()})),n.on("dragmove",(function(){d.show(),drawing=!1,r=n.getPosition(),l.setAttrs({points:[i.x,i.y,r.x,r.y]}),c.x(d.getWidth()-20),u.x(d.getWidth()-25),h.x(d.getWidth()-0),g.x(d.getWidth()-40),textlayer.batchDraw()})),c.on("touchstart click",(()=>{d.destroy(),l.destroy(),s.destroy(),n.destroy(),stage.draw()})),u.on("touchstart click",(()=>{d.destroy(),l.destroy(),s.destroy(),n.destroy(),stage.draw()})),g.on("click touchstart",(()=>{l.setAttrs({stroke:getRandomColor()}),stage.draw()})),h.on("click touchstart",(()=>{d.hide(),stage.draw()})),n.on("mouseover",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.add("grabbable")})),s.on("mouseover",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.add("grabbable")})),n.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser"))})),s.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser"))})),g.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),this.setAttrs({fillRadialGradientStartPoint:{x:0,y:0},fillRadialGradientStartRadius:0,fillRadialGradientEndPoint:{x:0,y:0},fillRadialGradientEndRadius:8,fillRadialGradientColorStops:[0,"blue",.5,"yellow",1,"red"]}),textlayer.draw()})),g.on("mouseout touchend",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),this.setAttrs({fillRadialGradientStartPoint:{x:0,y:0},fillRadialGradientStartRadius:0,fillRadialGradientEndPoint:{x:0,y:0},fillRadialGradientEndRadius:8,fillRadialGradientColorStops:[0,"red",.5,"yellow",1,"blue"]}),textlayer.draw()})),h.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),this.setAttrs({fill:"#CCCCCC"}),textlayer.draw(),is_touch_device()&&this.setAttrs({fill:"grey"})})),h.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),this.setAttrs({fill:"grey"}),textlayer.draw()})),c.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),this.setAttrs({fill:"#AA0000"}),textlayer.draw(),is_touch_device()&&this.setAttrs({fill:"red"})})),c.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),this.setAttrs({fill:"red"}),textlayer.draw()})),u.on("mouseover touchstart",(function(){Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pointer"),c.setAttrs({fill:"#AA0000"}),textlayer.draw(),is_touch_device()&&c.setAttrs({fill:"red"})})),u.on("mouseout",(function(){"brush"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("pencil")),"eraser"===mode&&(Mousemode.classList.remove("pencil"),Mousemode.classList.remove("pointer"),Mousemode.classList.remove("eraser"),Mousemode.classList.remove("grabbable"),Mousemode.classList.add("eraser")),c.setAttrs({fill:"red"}),textlayer.draw()}))}function fitStageIntoParentContainer(){isPaint=!1;var e=document.querySelector("#stage-parent"),t=e.offsetWidth,o=e.offsetHeight;scalex=t/width,scaley=o/height,stage.width(width*scalex),stage.height(height*scaley),stage.scale({x:scalex,y:scaley}),stage.batchDraw()}function clearContext(){context.clearRect(0,0,canvas.width,canvas.height),stage.draw()}window.addEventListener("resize",fitStageIntoParentContainer);